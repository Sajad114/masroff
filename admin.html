<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم - الأدمن</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #00f2fe, #4facfe);
      color: #fff;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    h2 { text-align: center; }
    input, select, button {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: none;
    }
    button {
      background: #673ab7;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #512da8; }
    table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid rgba(255,255,255,0.3);
      padding: 10px;
      text-align: center;
    }
    .progress {
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-bar {
      height: 20px;
      background: #4caf50;
      width: 0%;
      transition: width 0.5s;
    }
    .task {
      background: rgba(255,255,255,0.15);
      padding: 10px;
      border-radius: 8px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>لوحة التحكم - الأدمن</h2>

  <!-- إضافة موظف -->
  <h3>➕ إضافة موظف</h3>
  <input type="text" id="empName" placeholder="اسم الموظف">
  <button onclick="addEmployee()">إضافة</button>

  <!-- جدول الموظفين -->
  <h3>👥 الموظفين</h3>
  <table>
    <thead>
      <tr><th>الموظف</th><th>الرابط</th><th>الإجراءات</th></tr>
    </thead>
    <tbody id="empTable"></tbody>
  </table>

  <!-- إضافة مهام -->
  <h3>📝 إضافة مهام</h3>
  <select id="empSelect"></select>
  <input type="date" id="taskDate">
  <div id="taskInputs">
    <input type="text" placeholder="أدخل مهمة">
  </div>
  <button onclick="addTaskInput()">➕ حقل جديد</button>
  <button onclick="saveTasks()">💾 حفظ المهام</button>

  <!-- متابعة -->
  <h3>📊 متابعة المهام</h3>
  <select id="trackEmp"></select>
  <button onclick="trackTasks()">عرض</button>
  <button onclick="downloadPDF()">📥 تحميل تقرير PDF</button>
  <div id="taskProgress"></div>
  <div id="taskList"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA7KirsWgafKXPsQfFl3v6ssMaAb_zjTps",
    authDomain: "tasks-bce7f.firebaseapp.com",
    databaseURL: "https://tasks-bce7f-default-rtdb.firebaseio.com",
    projectId: "tasks-bce7f",
    storageBucket: "tasks-bce7f.firebasestorage.app",
    messagingSenderId: "493499367071",
    appId: "1:493499367071:web:c667a4666f1e84d8b32caa",
    measurementId: "G-HR305C8QHR"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function addEmployee(){
    const name = document.getElementById("empName").value.trim();
    if(!name) return alert("⚠️ أدخل الاسم");
    const newEmpRef = db.ref("employees").push();
    newEmpRef.set({name:name,date:new Date().toISOString()})
      .then(()=>{ alert("✅ تمت الإضافة"); document.getElementById("empName").value=""; })
      .catch(e=>alert("❌ خطأ: "+e.message));
  }

  function loadEmployees(){
    db.ref("employees").on("value", snapshot=>{
      const data = snapshot.val();
      const empTable=document.getElementById("empTable");
      const empSelect=document.getElementById("empSelect");
      const trackEmp=document.getElementById("trackEmp");
      empTable.innerHTML=""; empSelect.innerHTML=""; trackEmp.innerHTML="";
      if(!data){
        empTable.innerHTML="<tr><td colspan='3'>لا يوجد موظفين</td></tr>";
        return;
      }
      for(let id in data){
        const emp=data[id];
        const link=window.location.origin+"/employee.html?emp="+id;
        empTable.innerHTML+=`
          <tr>
            <td>${emp.name}</td>
            <td><a href="${link}" target="_blank">${link}</a></td>
            <td><button onclick="copyLink('${link}')">📋 نسخ</button> 
            <button onclick="deleteEmp('${id}')">🗑 حذف</button></td>
          </tr>`;
        empSelect.innerHTML+=`<option value="${id}">${emp.name}</option>`;
        trackEmp.innerHTML+=`<option value="${id}">${emp.name}</option>`;
      }
    });
  }
  loadEmployees();

  function copyLink(link){ navigator.clipboard.writeText(link); alert("📋 تم نسخ الرابط"); }
  function deleteEmp(id){ db.ref("employees/"+id).remove(); }

  function addTaskInput(){ document.getElementById("taskInputs").innerHTML+=`<input type="text" placeholder="أدخل مهمة">`; }

  function saveTasks(){
    const empId=document.getElementById("empSelect").value;
    const date=document.getElementById("taskDate").value;
    const inputs=document.querySelectorAll("#taskInputs input");
    const tasks=[];
    inputs.forEach(inp=>{ if(inp.value) tasks.push({text:inp.value,status:"pending",delays:0}); });
    if(tasks.length>0){
      db.ref("tasks/"+empId+"/"+date).set(tasks);
      alert("✅ تم حفظ المهام");
      document.getElementById("taskInputs").innerHTML='<input type="text" placeholder="أدخل مهمة">';
    }
  }

  function trackTasks(){
    const empId=document.getElementById("trackEmp").value;
    const today=new Date().toISOString().split("T")[0];
    db.ref("tasks/"+empId+"/"+today).once("value",snap=>{
      const tasks=snap.val()||[];
      let done=tasks.filter(t=>t.status==="done").length;
      let total=tasks.length;
      let percent=total? (done/total*100):0;
      document.getElementById("taskProgress").innerHTML=`
        <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
        <p>${done} / ${total} مكتملة</p>`;
      document.getElementById("taskList").innerHTML=tasks.map(t=>`<div class="task">${t.text} - ${t.status} (تأجيل:${t.delays})</div>`).join("");
    });
  }

  function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    doc.text("تقرير المهام",10,10);
    doc.text(document.getElementById("taskList").innerText,10,20);
    doc.save("tasks-report.pdf");
  }
</script>
</body>
</html>
