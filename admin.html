<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- jsPDF Ù„ØªÙ‚Ø§Ø±ÙŠØ± PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,0.16);
      --glass-stroke: rgba(255,255,255,0.35);
      --txt: #0b1630;
      --primary: #6f49ff;
      --primary-2: #5536e6;
      --ok: #2e7d32;
      --warn: #f57c00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:24px;
      font-family: "Cairo", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(135deg,#00f2fe,#4facfe);
      color: var(--txt);
    }
    .wrap{
      max-width:1100px;margin:auto;
      background: var(--glass-bg);
      backdrop-filter: blur(14px);
      border: 1px solid var(--glass-stroke);
      border-radius:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      padding:20px;
    }
    h1,h2,h3{margin:10px 0 12px}
    .row{display:flex;flex-wrap:wrap;gap:12px}
    .card{
      flex:1 1 330px;min-width:300px;
      background: rgba(255,255,255,0.22);
      border:1px solid var(--glass-stroke);
      border-radius:12px;padding:16px
    }
    input,select,button{
      padding:10px 12px;border-radius:10px;border:1px solid var(--glass-stroke);
      background: rgba(255,255,255,0.75);
      font-size:14px
    }
    button{background:var(--primary);color:#fff;border:none;cursor:pointer;transition:.2s}
    button:hover{background:var(--primary-2)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid var(--glass-stroke);padding:10px;text-align:center;background:rgba(255,255,255,0.6)}
    .progress{background:rgba(255,255,255,0.5);border-radius:30px;overflow:hidden}
    .bar{height:18px;width:0;background:#2ecc71;transition:width .5s}
    .task{background:rgba(255,255,255,0.7);padding:8px;border-radius:8px;margin:6px 0}
    .muted{opacity:.7}
    .actions button{margin:0 4px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill.ok{background:#e8f5e9;color:#1b5e20;border:1px solid #c8e6c9}
    .pill.warn{background:#fff3e0;color:#e65100;border:1px solid #ffe0b2}
    .hint{font-size:12px;opacity:.8;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø£Ø¯Ù…Ù†</h1>

    <div class="row">
      <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù -->
      <div class="card">
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h3>
        <div class="row">
          <input type="text" id="empName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" style="flex:1">
          <button onclick="addEmployee()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div class="hint">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ¸Ù‡Ø± Ø±Ø§Ø¨Ø· Ø®Ø§Øµ Ù„Ù„Ù…ÙˆØ¸Ù.</div>
      </div>

      <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ù… -->
      <div class="card">
        <h3>ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ø§Ù… Ù„Ù…ÙˆØ¸Ù</h3>
        <div class="row">
          <select id="empSelect" style="flex:1"></select>
          <input type="date" id="taskDate" style="flex:1">
        </div>
        <div id="taskInputs" class="row">
          <input type="text" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø©" style="flex:1 1 100%">
        </div>
        <div class="row">
          <button onclick="addTaskInput()">â• Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯</button>
          <button onclick="saveTasks()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
    <div class="card" style="margin-top:12px">
      <h3>ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</h3>
      <table>
        <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody id="empTable"></tbody>
      </table>
      <div class="hint">Ø¥Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø§ ÙŠÙØªØ­ØŒ ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù <b>employee.html</b> ÙÙŠ <b>Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯</b> Ù…Ø¹ <b>admin.html</b>.</div>
    </div>

    <!-- Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© -->
    <div class="card" style="margin-top:12px">
      <h3>ğŸ“Š Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="row">
        <select id="trackEmp" style="flex:1"></select>
        <button onclick="trackTasks()">Ø¹Ø±Ø¶</button>
        <button onclick="downloadPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF</button>
      </div>
      <div class="progress" style="margin-top:12px"><div class="bar" id="progBar"></div></div>
      <p id="progText" class="muted">0 / 0 Ù…ÙƒØªÙ…Ù„Ø©</p>
      <div id="taskList"></div>
    </div>
  </div>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyA7KirsWgafKXPsQfFl3v6ssMaAb_zjTps",
    authDomain: "tasks-bce7f.firebaseapp.com",
    databaseURL: "https://tasks-bce7f-default-rtdb.firebaseio.com",
    projectId: "tasks-bce7f",
    storageBucket: "tasks-bce7f.firebasestorage.app",
    messagingSenderId: "493499367071",
    appId: "1:493499367071:web:c667a4666f1e84d8b32caa",
    measurementId: "G-HR305C8QHR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =====
  const localYMD = (d=new Date())=>{
    const ms = d.getTime() - d.getTimezoneOffset()*60000;
    return new Date(ms).toISOString().slice(0,10);
  };

  // Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ø´ÙƒÙ„ "Ù†Ø³Ø¨ÙŠ" Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ â€“ ÙŠØµÙ„Ø­ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
  function buildEmployeeLink(empId){
    // ÙŠØ¨Ù†ÙŠ employee.html Ø¯Ø§Ø®Ù„ Ù†ÙØ³ ÙÙˆÙ„Ø¯Ø± admin.html
    return new URL(`employee.html?emp=${empId}`, window.location.href).href;
  }

  // ===== Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù =====
  function addEmployee(){
    const name = document.getElementById("empName").value.trim();
    if(!name){ alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…"); return; }
    const ref = db.ref("employees").push();
    ref.set({ name, createdAt: new Date().toISOString() })
      .then(()=>{ alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù"); document.getElementById("empName").value=""; })
      .catch(err=> alert("âŒ Ø®Ø·Ø£: "+err.message));
  }

  // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† + ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… =====
  function loadEmployees(){
    db.ref("employees").on("value", snap=>{
      const data = snap.val();
      const empTable = document.getElementById("empTable");
      const empSelect = document.getElementById("empSelect");
      const trackEmp = document.getElementById("trackEmp");
      empTable.innerHTML = ""; empSelect.innerHTML = ""; trackEmp.innerHTML = "";

      if(!data){
        empTable.innerHTML = "<tr><td colspan='3'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ø¨Ø¹Ø¯</td></tr>";
        return;
      }
      Object.keys(data).forEach(id=>{
        const emp = data[id];
        const link = buildEmployeeLink(id);
        empTable.innerHTML += `
          <tr>
            <td>${emp.name}</td>
            <td style="word-break:break-all">
              <a href="${link}" target="_blank">${link}</a>
            </td>
            <td class="actions">
              <button onclick="copyLink('${link}')">ğŸ“‹ Ù†Ø³Ø®</button>
              <button onclick="window.open('${link}','_blank')">ğŸ”— ÙØªØ­</button>
              <button onclick="deleteEmp('${id}')">ğŸ—‘ Ø­Ø°Ù</button>
            </td>
          </tr>`;
        empSelect.innerHTML += `<option value="${id}">${emp.name}</option>`;
        trackEmp.innerHTML += `<option value="${id}">${emp.name}</option>`;
      });
    });
  }
  loadEmployees();

  function copyLink(link){ navigator.clipboard.writeText(link); alert("ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·"); }
  function deleteEmp(id){
    if(confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù…Ù‡ØŸ")) db.ref("employees/"+id).remove();
  }

  // ===== Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ù…Ù‡Ø§Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© =====
  function addTaskInput(){
    const c = document.getElementById("taskInputs");
    const input = document.createElement("input");
    input.type = "text"; input.placeholder = "Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø©"; input.style.flex = "1 1 100%";
    c.appendChild(input);
  }

  // ===== Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ø§Ù… (Ù…ØµÙÙˆÙØ© Ø¯Ø§Ø¦Ù…Ø©) =====
  function saveTasks(){
    const empId = document.getElementById("empSelect").value;
    const date = document.getElementById("taskDate").value;
    if(!empId || !date){ alert("âš ï¸ Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù ÙˆØªØ§Ø±ÙŠØ®"); return; }

    const inputs = [...document.querySelectorAll("#taskInputs input")];
    let tasks = inputs.map(inp => inp.value.trim()).filter(Boolean).map(t => ({text:t, status:"pending", delays:0}));
    if(tasks.length===0){ alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }

    // Ø®Ø²Ù‘Ù† ÙƒÙ…ØµÙÙˆÙØ©
    db.ref(`tasks/${empId}/${date}`).set(tasks)
      .then(()=>{
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ø§Ù…");
        document.getElementById("taskInputs").innerHTML = `<input type="text" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø©" style="flex:1 1 100%">`;
      })
      .catch(err=> alert("âŒ Ø®Ø·Ø£: "+err.message));
  }

  // ===== Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… =====
  function asArray(value){
    if(Array.isArray(value)) return value;
    if(value && typeof value === 'object') return Object.values(value);
    return [];
  }

  function trackTasks(){
    const empId = document.getElementById("trackEmp").value;
    const today = localYMD(); // ØªØ§Ø±ÙŠØ® Ù…Ø­Ù„ÙŠ
    db.ref(`tasks/${empId}/${today}`).once("value", snap=>{
      let tasks = asArray(snap.val());
      let done = tasks.filter(t=>t.status==="done").length;
      let total = tasks.length;
      let percent = total? Math.round(done/total*100) : 0;

      document.getElementById("progBar").style.width = percent+"%";
      document.getElementById("progText").innerHTML = `${done} / ${total} Ù…ÙƒØªÙ…Ù„Ø©`;

      document.getElementById("taskList").innerHTML = tasks.map(t=>{
        const badge = t.delays>0 ? `<span class="pill warn">ØªØ£Ø¬ÙŠÙ„: ${t.delays}</span>` : `<span class="pill ok">Ø¬Ø¯ÙŠØ¯</span>`;
        return `<div class="task">${t.text} &nbsp; ${badge} &nbsp; <span class="muted">(${t.status})</span></div>`;
      }).join("");
    });
  }

  // ===== ØªÙ‚Ø±ÙŠØ± PDF Ø³Ø±ÙŠØ¹ =====
  function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const empSel = document.getElementById("trackEmp");
    const empName = empSel.options[empSel.selectedIndex]?.text || "Ù…ÙˆØ¸Ù";
    doc.setFont("helvetica","bold"); doc.setFontSize(14);
    doc.text(`ØªÙ‚Ø±ÙŠØ± Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… - ${empName}`, 10, 12);
    doc.setFont("helvetica","normal"); doc.setFontSize(12);

    const list = document.getElementById("taskList").innerText || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…";
    let lines = doc.splitTextToSize(list, 180);
    doc.text(lines, 10, 24);
    doc.save("tasks-report.pdf");
  }
</script>
</body>
</html>
