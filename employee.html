<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ù‡Ø§Ù…ÙŠ - Ø§Ù„Ù…ÙˆØ¸Ù</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --glass: rgba(255,255,255,0.2);
      --stroke: rgba(255,255,255,0.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      color:#fff;
    }
    .card{
      width:95%;max-width:620px;padding:20px;border-radius:16px;
      background: var(--glass); backdrop-filter: blur(15px);
      border:1px solid var(--stroke);
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      text-align:center;
    }
    h2{margin:6px 0 10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    button{
      padding:10px 12px;border-radius:10px;border:none;cursor:pointer
    }
    .pdf-btn{background:#2196f3;color:#fff}
    .progress{background: rgba(255,255,255,0.3);border-radius:30px;overflow:hidden;margin:12px 0}
    .bar{height:18px;background:#4caf50;width:0;transition:width .5s}
    .section-title{margin:10px 0 6px}
    .task{
      background: rgba(255,255,255,0.16); padding:12px;border-radius:10px;
      display:flex;align-items:center;justify-content:space-between;margin:8px 0
    }
    .task.done{background: rgba(76,175,80,0.5); text-decoration: line-through}
    .left button{margin-inline-start:6px}
    .done-btn{background:#4caf50;color:#fff}
    .delay-btn{background:#ff9800;color:#fff}
    .delays{font-size:12px;color:#ffe082;margin-inline-start:6px}
    #toast{position:fixed;bottom:18px;right:18px;background:rgba(0,0,0,.75);padding:10px 14px;border-radius:10px;display:none}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="empName">Ù…Ù‡Ø§Ù…ÙŠ</h2>
    <div class="row"><button class="pdf-btn" onclick="downloadPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF</button></div>
    <div class="progress"><div class="bar" id="prog"></div></div>
    <p id="stat">0 / 0 Ù…ÙƒØªÙ…Ù„Ø©</p>

    <h3 class="section-title">ğŸ“Œ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h3>
    <div id="today"></div>

    <h3 class="section-title">â³ Ù…Ù‡Ø§Ù… Ù…Ø¤Ø¬Ù„Ø©</h3>
    <div id="delayed"></div>
  </div>
  <div id="toast"></div>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyA7KirsWgafKXPsQfFl3v6ssMaAb_zjTps",
    authDomain: "tasks-bce7f.firebaseapp.com",
    databaseURL: "https://tasks-bce7f-default-rtdb.firebaseio.com",
    projectId: "tasks-bce7f",
    storageBucket: "tasks-bce7f.firebasestorage.app",
    messagingSenderId: "493499367071",
    appId: "1:493499367071:web:c667a4666f1e84d8b32caa",
    measurementId: "G-HR305C8QHR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ===== Helpers =====
  const q = new URLSearchParams(location.search);
  const empId = q.get("emp");
  const localYMD = (d=new Date())=>{
    const ms = d.getTime() - d.getTimezoneOffset()*60000;
    return new Date(ms).toISOString().slice(0,10);
  };
  const asArray = v => Array.isArray(v) ? v : (v && typeof v==="object" ? Object.values(v) : []);

  const toast = msg => {
    const t = document.getElementById("toast");
    t.textContent = msg; t.style.display="block"; setTimeout(()=>t.style.display="none",2500);
  };

  if(!empId){
    document.body.innerHTML = "<h2 style='color:white'>âŒ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± ØµØ­ÙŠØ­</h2>";
  }else{
    init(empId);
  }

  function init(id){
    // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
    db.ref(`employees/${id}`).once("value", s=>{
      if(s.exists()) document.getElementById("empName").textContent = "ğŸ‘¤ " + (s.val().name || "Ù…ÙˆØ¸Ù");
    });

    // Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… (ØªØ§Ø±ÙŠØ® Ù…Ø­Ù„ÙŠ)
    const today = localYMD();
    db.ref(`tasks/${id}/${today}`).on("value", s=>{
      const tasks = asArray(s.val());
      render(tasks, id, today);
    });
  }

  function render(tasks, id, date){
    const todayEl = document.getElementById("today");
    const delayedEl = document.getElementById("delayed");
    todayEl.innerHTML = ""; delayedEl.innerHTML = "";

    let done = 0;
    tasks.forEach((t, i)=>{
      if(t.status==="done") done++;
      const row = document.createElement("div");
      row.className = "task " + (t.status==="done"?"done":"");
      row.innerHTML = `
        <span>${t.text} <span class="delays">${t.delays>0? "(ØªØ£Ø¬ÙŠÙ„: "+t.delays+")" : ""}</span></span>
        <div class="left">
          <button class="done-btn" onclick="finishTask('${id}','${date}',${i})">âœ”</button>
          <button class="delay-btn" onclick="delayTask('${id}','${date}',${i})">â³</button>
        </div>
      `;
      (t.delays>0 ? delayedEl : todayEl).appendChild(row);
    });

    const total = tasks.length;
    const pct = total? Math.round(done/total*100) : 0;
    document.getElementById("prog").style.width = pct+"%";
    document.getElementById("stat").textContent = `${done} / ${total} Ù…ÙƒØªÙ…Ù„Ø©`;
  }

  // Ø­ÙØ¸ "ØªÙ…" Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ù„Ù…ØµÙÙˆÙØ©
  function finishTask(empId, date, index){
    db.ref(`tasks/${empId}/${date}`).once("value", s=>{
      let arr = asArray(s.val());
      if(!arr[index]) return;
      arr[index].status = "done";
      db.ref(`tasks/${empId}/${date}`).set(arr);
      toast("âœ… ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø©");
    });
  }

  // ØªØ£Ø¬ÙŠÙ„ ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø¨ÙÙ†ÙŠØ© Ø§Ù„Ù…ØµÙÙˆÙØ© ÙÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠÙ†
  function delayTask(empId, date, index){
    const next = localYMD(new Date(new Date(date).getTime()+24*60*60*1000));

    // Ø­Ù…Ù‘Ù„ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
    db.ref(`tasks/${empId}/${date}`).once("value", s=>{
      let today = asArray(s.val());
      if(!today[index]) return;

      // Ø­Ø¶Ù‘Ø± Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©
      let task = today[index];
      task.status = "pending";
      task.delays = (task.delays||0) + 1;

      // Ø­Ù…Ù‘Ù„ Ù…Ù‡Ø§Ù… Ø§Ù„ØºØ¯ ÙƒÙ…ØµÙÙˆÙØ© Ø«Ù… Ø£Ø¶Ù Ø¥Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù…Ù‡Ù…Ø©
      db.ref(`tasks/${empId}/${next}`).once("value", s2=>{
        let nextArr = asArray(s2.val());
        nextArr.push(task);

        // Ø§ÙƒØªØ¨ Ø§Ù„ØºØ¯ ÙƒÙ…ØµÙÙˆÙØ© Ø«Ù… Ø­Ø¯Ù‘Ø« Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©
        Promise.all([
          db.ref(`tasks/${empId}/${next}`).set(nextArr),
          (today.splice(index,1), db.ref(`tasks/${empId}/${date}`).set(today))
        ]).then(()=> toast("â³ ØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ØªØ§Ù„ÙŠ"));
      });
    });
  }

  // PDF Ø¨Ø³ÙŠØ· Ù…Ù† Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„ØµÙØ­Ø©
  function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const title = document.getElementById("empName").innerText || "Ù…Ù‡Ø§Ù…ÙŠ";
    doc.setFont("helvetica","bold"); doc.setFontSize(14);
    doc.text(title, 10, 12);
    doc.setFont("helvetica","normal"); doc.setFontSize(12);

    let y = 22;
    const blocks = [...document.querySelectorAll(".task")].map(el=>el.innerText);
    if(blocks.length===0){ doc.text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ….", 10, y); }
    else{
      blocks.forEach(line=>{
        const chunk = doc.splitTextToSize(line, 180);
        doc.text(chunk, 10, y);
        y += 8 + chunk.length*6;
      });
    }
    doc.save("my-tasks.pdf");
  }
</script>
</body>
</html>
