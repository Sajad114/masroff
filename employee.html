<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>بوابة الموظف - مهامي</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  :root{
    --bg:#0b1220;--card:#111a2b;--glass:rgba(255,255,255,.06);
    --text:#e7f0ff;--muted:#a6b2c8;--brand:#55c2ff;--ok:#2ad084;--warn:#ffb84d;--line:rgba(255,255,255,.12);
    --radius:14px;--shadow:0 12px 40px rgba(0,0,0,.35)
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, rgba(85,194,255,.25), transparent 40%),linear-gradient(160deg,#091427,#0a1630 60%,#0b152b);color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  header{
    position:sticky;top:0;background:rgba(10,17,33,.7);backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line);z-index:10;padding:16px;text-align:center
  }
  .container{max-width:900px;margin:24px auto;padding:0 16px}
  .panel{background:var(--glass);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 12px;border-radius:999px;border:1px solid var(--line);background:#0e1728}
  .points{font-weight:900;color:#c9ffd8}
  .progress{height:12px;background:#0f1a2e;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#2ad084,#8df4d0)}
  table{width:100%;border-collapse:collapse;margin-top:12px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:11px;border-bottom:1px solid var(--line);text-align:center}
  th{background:rgba(255,255,255,.06);color:#bfe6ff}
  tr:hover{background:rgba(255,255,255,.04)}
  button{padding:7px 12px;border:none;border-radius:10px;cursor:pointer}
  .ok{background:var(--ok);color:#092016;font-weight:800}
  .warn{background:var(--warn);color:#1d1203;font-weight:800}
  .muted{color:var(--muted)}
  .toast{position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#0e1728;border:1px solid var(--line);padding:10px 14px;border-radius:10px;display:none;z-index:50}
  .toast.show{display:block;animation:fade .2s} @keyframes fade{from{opacity:.6;transform:translate(-50%,-6px)}to{opacity:1;transform:translate(-50%,0)}}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:100}
  .modal .box{width:min(92%,420px);background:#0e1728;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:16px}
  textarea,input{width:100%;background:#0c1526;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px;outline:none}
  .box .row-end{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
</style>
</head>
<body>

<header>
  <div class="row" style="justify-content:center;gap:12px">
    <div id="empName" class="badge">👤 الموظف: ...</div>
    <div class="badge">🏆 النقاط: <span id="points" class="points">0</span></div>
    <div class="badge muted">📅 <span id="today"></span></div>
  </div>
</header>

<div class="container">
  <div class="panel">
    <div class="row"><b>نسبة إنجاز مهام اليوم</b></div>
    <div class="progress" style="margin-top:10px"><div id="bar" class="bar"></div></div>
  </div>

  <div class="panel">
    <h3>📋 مهام اليوم</h3>
    <table>
      <thead><tr><th>المهمة</th><th>إجراء</th></tr></thead>
      <tbody id="dailyBody"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>⏳ المهام المؤجّلة</h3>
    <table>
      <thead><tr><th>المهمة</th><th>السبب</th><th>التاريخ المقترح</th></tr></thead>
      <tbody id="delayedBody"></tbody>
    </table>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- تأجيل: سبب -->
<div id="delayModal" class="modal">
  <div class="box">
    <h3>سبب التأجيل</h3>
    <div class="muted" style="margin:6px 0">الرجاء كتابة ملاحظة قصيرة عن سبب تأجيل المهمة.</div>
    <textarea id="delayReason" rows="4" placeholder="مثال: انتظار موافقة العميل..."></textarea>
    <div class="row-end">
      <button onclick="closeDelay()" class="muted">إلغاء</button>
      <button class="warn" onclick="confirmDelay()">تأجيل</button>
    </div>
  </div>
</div>

<script>
  /* ================= Firebase ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyA7KirsWgafKXPsQfFl3v6ssMaAb_zjTps",
    authDomain: "tasks-bce7f.firebaseapp.com",
    databaseURL: "https://tasks-bce7f-default-rtdb.firebaseio.com",
    projectId: "tasks-bce7f",
    storageBucket: "tasks-bce7f.firebasestorage.app",
    messagingSenderId: "493499367071",
    appId: "1:493499367071:web:c667a4666f1e84d8b32caa",
    measurementId: "G-HR305C8QHR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const url = new URLSearchParams(location.search);
  const empId = url.get("emp");
  const EMP_REF = db.ref("employees");
  const DAILY_REF = db.ref("tasksDaily");
  const DELAYED_REF = db.ref("delayedTasks");
  const ACTIVITY_REF = db.ref("activity");

  const $ = s=>document.querySelector(s);
  const todayStr = ()=> new Date().toISOString().slice(0,10);
  const toast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); };

  $("#today").textContent = todayStr();

  let empName=""; let empPoints=0;
  let selectedTaskId = null;

  // الاسم + النقاط
  if(!empId){
    $("#empName").textContent = "رابط الموظف غير صالح";
  }else{
    EMP_REF.child(empId).on("value", s=>{
      const v=s.val()||{}; empName=v.name||"—"; empPoints=v.points||0;
      $("#empName").textContent = "👤 الموظف: " + empName;
      $("#points").textContent = empPoints;
    });
  }

  // تحميل مهام اليوم
  function loadDaily(){
    const date=todayStr(); const tbody=$("#dailyBody"); tbody.innerHTML="";
    DAILY_REF.child(`${empId}/${date}`).on("value", snap=>{
      const tasks = snap.val()||{};
      tbody.innerHTML="";
      let total=0, done=0;
      for(const id in tasks){
        const t = tasks[id];
        if(t.status==="done"){ done++; continue; } // لا نعرض المنجزة
        total++;
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${t.text}</td>
          <td>
            <button class="ok" onclick="completeTask('${id}')">✔ تم الإنجاز</button>
            <button class="warn" onclick="openDelay('${id}')">⏳ تأجيل</button>
          </td>`;
        tbody.appendChild(tr);
      }
      const percent = (total+done) ? Math.round((done/(total+done))*100) : 0;
      $("#bar").style.width = percent + "%";
    });
  }

  // تحميل المؤجلة
  function loadDelayed(){
    const tbody=$("#delayedBody"); tbody.innerHTML="";
    DELAYED_REF.child(empId).on("value", snap=>{
      const data=snap.val()||{};
      tbody.innerHTML="";
      for(const tid in data){
        const t=data[tid];
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${t.text||"—"}</td><td>${t.reason||"-"}</td><td>${(t.targetDate||"—").slice(0,10)}</td>`;
        tbody.appendChild(tr);
      }
    });
  }

  // إنجاز
  function completeTask(taskId){
    const date = todayStr();
    const ref = DAILY_REF.child(`${empId}/${date}/${taskId}`);
    ref.once("value").then(s=>{
      const task = s.val(); if(!task) return;
      // احذفها من اليوم
      ref.remove().then(()=>{
        // فعالية + نقطة + رسالة
        ACTIVITY_REF.child(empId).push({type:"done", text:task.text, at:Date.now()});
        EMP_REF.child(`${empId}/points`).transaction(p => (p||0)+1);
        toast("✅ شكراً على خدمتكم");
      });
    });
  }

  // تأجيل
  function openDelay(taskId){ selectedTaskId = taskId; $("#delayModal").style.display="flex"; }
  function closeDelay(){ $("#delayModal").style.display="none"; $("#delayReason").value=""; }
  function confirmDelay(){
    const reason = ($("#delayReason").value||"").trim();
    if(!reason){ toast("⚠️ يرجى كتابة سبب التأجيل"); return; }
    const date = todayStr();
    const ref = DAILY_REF.child(`${empId}/${date}/${selectedTaskId}`);
    ref.once("value").then(s=>{
      const task=s.val(); if(!task) { closeDelay(); return; }
      const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate()+1);
      const nextStr = tomorrow.toISOString().slice(0,10);
      // ضافة للمؤجلة
      DELAYED_REF.child(`${empId}/${selectedTaskId}`).set({
        text:task.text, reason, delayCount:(task.delayCount||0)+1,
        createdAt:task.createdAt||Date.now(), targetDate: nextStr
      }).then(()=>{
        // احذف من اليوم
        ref.remove().then(()=>{
          ACTIVITY_REF.child(empId).push({type:"delay", text:task.text, reason, at:Date.now()});
          closeDelay(); toast("⏳ تم التأجيل ونقل المهمة إلى المؤجلة");
        });
      });
    });
  }

  // بدء
  if(empId){ loadDaily(); loadDelayed(); }
</script>
</body>
</html>
