<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ù‡Ø§Ù…ÙŠ - Ø§Ù„Ù…ÙˆØ¸Ù</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 95%;
      max-width: 600px;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(15px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      color: #fff;
      text-align: center;
    }
    h2 { margin-bottom: 10px; }
    button {
      margin: 5px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .pdf-btn { background: #2196f3; color: white; }
    .progress { background: rgba(255,255,255,0.2); border-radius: 20px; overflow: hidden; margin: 15px 0; }
    .progress-bar { height: 20px; background: #4caf50; width: 0%; transition: width 0.5s; }
    .task { background: rgba(255,255,255,0.15); margin: 10px 0; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
    .task.done { background: rgba(76,175,80,0.5); text-decoration: line-through; }
    .done-btn { background: #4caf50; color:white; }
    .delay-btn { background: #ff9800; color:white; }
    .delays { font-size: 12px; color: #ffd54f; }
    #toast { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 8px; display: none; }
  </style>
</head>
<body>
<div class="container">
  <h2 id="empName">Ù…Ù‡Ø§Ù…ÙŠ</h2>
  <button class="pdf-btn" onclick="downloadPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF</button>
  <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
  <p id="progressText">0 / 0 Ù…ÙƒØªÙ…Ù„Ø©</p>
  <h3>ğŸ“Œ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h3>
  <div id="todayTasks"></div>
  <h3>â³ Ù…Ù‡Ø§Ù… Ù…Ø¤Ø¬Ù„Ø©</h3>
  <div id="delayedTasks"></div>
</div>
<div id="toast"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA7KirsWgafKXPsQfFl3v6ssMaAb_zjTps",
    authDomain: "tasks-bce7f.firebaseapp.com",
    databaseURL: "https://tasks-bce7f-default-rtdb.firebaseio.com",
    projectId: "tasks-bce7f",
    storageBucket: "tasks-bce7f.firebasestorage.app",
    messagingSenderId: "493499367071",
    appId: "1:493499367071:web:c667a4666f1e84d8b32caa",
    measurementId: "G-HR305C8QHR"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const urlParams = new URLSearchParams(window.location.search);
  const empId = urlParams.get("emp");

  if(!empId){ document.body.innerHTML="<h2 style='color:white'>âŒ Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­</h2>"; }
  else { loadEmployee(empId); }

  function showToast(msg){ const t=document.getElementById("toast"); t.innerText=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",3000); }

  function loadEmployee(empId){
    db.ref("employees/"+empId).once("value",snap=>{
      if(snap.exists()){ document.getElementById("empName").innerText="ğŸ‘¤ "+snap.val().name; }
    });
    const today=new Date().toISOString().split("T")[0];
    db.ref("tasks/"+empId+"/"+today).on("value",snap=>{
      renderTasks(snap.val()||[], empId, today);
    });
  }

  function renderTasks(tasks, empId, date){
    const todayContainer=document.getElementById("todayTasks");
    const delayedContainer=document.getElementById("delayedTasks");
    todayContainer.innerHTML=""; delayedContainer.innerHTML="";
    let doneCount=0;
    tasks.forEach((task,i)=>{
      if(task.status==="done") doneCount++;
      const div=document.createElement("div");
      div.className="task "+(task.status==="done"?"done":"");
      div.innerHTML=`
        <span>${task.text} <span class="delays">${task.delays>0?"(ØªØ£Ø¬ÙŠÙ„:"+task.delays+")":""}</span></span>
        <div>
          <button class="done-btn" onclick="finishTask('${empId}','${date}',${i})">âœ”</button>
          <button class="delay-btn" onclick="delayTask('${empId}','${date}',${i})">â³</button>
        </div>`;
      if(task.delays>0) delayedContainer.appendChild(div);
      else todayContainer.appendChild(div);
    });
    let percent=tasks.length?(doneCount/tasks.length*100):0;
    document.getElementById("progressBar").style.width=percent+"%";
    document.getElementById("progressText").innerText=`${doneCount} / ${tasks.length} Ù…ÙƒØªÙ…Ù„Ø©`;
  }

  function finishTask(empId,date,index){ db.ref("tasks/"+empId+"/"+date+"/"+index+"/status").set("done"); showToast("âœ… ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²"); }
  function delayTask(empId,date,index){
    db.ref("tasks/"+empId+"/"+date).once("value",snap=>{
      let tasks=snap.val()||[];
      let task=tasks[index]; task.status="pending"; task.delays=(task.delays||0)+1;
      let tomorrow=new Date(date); tomorrow.setDate(tomorrow.getDate()+1);
      let next=tomorrow.toISOString().split("T")[0];
      db.ref("tasks/"+empId+"/"+next).push(task);
      tasks.splice(index,1);
      db.ref("tasks/"+empId+"/"+date).set(tasks);
      showToast("â³ ØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©");
    });
  }

  function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    doc.text("ØªÙ‚Ø±ÙŠØ± Ù…Ù‡Ø§Ù…ÙŠ",10,10);
    let tasks=document.querySelectorAll(".task");
    let y=20;
    tasks.forEach(t=>{ doc.text(t.innerText,10,y); y+=10; });
    doc.save("my-tasks.pdf");
  }
</script>
</body>
</html>
