<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Liquid Glass Table Builder v2 â€” Turquoise Olive Edition</title>

<!-- Ø®Ø·ÙˆØ· -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">

<!-- Ù…ÙƒØªØ¨Ø§Øª: SheetJS, html2canvas, html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --accent: #39c2a6; /* ÙÙŠØ±ÙˆØ²ÙŠ-Ø²ÙŠØªÙˆÙ†ÙŠ */
    --accent-weak: rgba(57,194,166,0.16);
    --glass-bg: rgba(140,200,180,0.10);
    --glass-border: rgba(180,255,220,0.28);
    --text: #e9fffb;
    --card-bg: rgba(0,0,0,0.18);
    --shadow: 0 10px 40px rgba(28, 120, 105, 0.12);
  }
  html,body{height:100%;margin:0;padding:0;font-family:'Tajawal',sans-serif;background:linear-gradient(135deg,#0b1f1a 0%, #092b27 40%, #071615 100%);color:var(--text);-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
  /* ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© */
  .app {
    max-width:1200px;
    margin:24px auto;
    padding:18px;
    display:flex;
    gap:18px;
    align-items:flex-start;
    justify-content:center;
  }

  /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠØ³Ø±Ù‰ â€” Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
  .preview {
    flex:1.1;
    min-width:320px;
    position:relative;
  }

  /* Ø®Ù„ÙÙŠØ© Ù…Ø§Ø¦ÙŠØ© Ù…ØªØ­Ø±ÙƒØ© */
  .liquid-bg {
    position:fixed;
    inset:0;
    z-index:0;
    pointer-events:none;
    overflow:hidden;
    opacity:0.9;
  }
  .wave {
    position:absolute;
    width:180%;
    height:60%;
    left:-40%;
    top:-10%;
    background: radial-gradient(60% 50% at 10% 10%, color-mix(in srgb,var(--accent) 20%, transparent), transparent 20%),
                radial-gradient(80% 60% at 80% 90%, color-mix(in srgb,var(--accent) 12%, transparent), transparent 30%);
    filter: blur(60px) saturate(150%);
    transform: translate3d(0,0,0);
    animation: floatWave 12s infinite alternate ease-in-out;
  }
  @keyframes floatWave{ from{transform:translateY(0) rotate(0deg)} to{transform:translateY(18px) rotate(1deg)} }

  /* ÙÙ‚Ø§Ø¹Ø§Øª */
  .bubbles{ position:absolute; inset:auto 0 0 0; height:260px; z-index:0; pointer-events:none; overflow:visible }
  .bubble{
    position:absolute;
    bottom:-30%;
    border-radius:50%;
    opacity:0.15;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.6), rgba(255,255,255,0.08));
    box-shadow: 0 4px 30px rgba(0,0,0,0.2);
    animation: rise 9s infinite linear;
    filter: blur(6px) saturate(120%);
  }
  @keyframes rise{ 0%{transform: translateY(0) scale(.8)} 100%{transform: translateY(-380%) scale(1.05); opacity:0} }

  /* Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ø­Ø§ÙˆÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ©) */
  .panel {
    position:relative;
    z-index:2;
    border-radius:18px;
    background:var(--glass-bg);
    backdrop-filter: blur(18px) saturate(150%);
    -webkit-backdrop-filter: blur(18px) saturate(150%);
    border:1px solid var(--glass-border);
    box-shadow: var(--shadow);
    padding:12px;
    overflow:hidden;
  }

  /* Ø¹Ù†ÙˆØ§Ù† */
  .panel .title {
    text-align:center;
    color: color-mix(in srgb, var(--accent) 70%, white 30%);
    font-weight:800;
    font-size:20px;
    margin:6px 0 12px;
    text-shadow:0 0 18px color-mix(in srgb,var(--accent) 40%,transparent);
  }

  /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  .table-wrap { padding:6px; }
  table.stylish { width:100%; border-collapse:collapse; text-align:center; font-size:15px; min-width:280px }
  table.stylish th, table.stylish td { padding:12px 10px; vertical-align:middle }
  table.stylish th {
    background: var(--accent-weak);
    color: color-mix(in srgb,var(--accent) 70%, white 40%);
    font-weight:700;
    font-size:14px;
    border-bottom:1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(6px);
  }
  table.stylish td {
    color:var(--text);
    border-bottom:1px solid rgba(255,255,255,0.04);
  }
  table.stylish tr:nth-child(even) td{ background: rgba(255,255,255,0.02) }
  table.stylish tr:hover td{ background: color-mix(in srgb,var(--accent) 10%, rgba(255,255,255,0.02)); transform: scale(1.01); transition: transform .18s ease }
  .size-small{ display:block; font-size:12px; color: rgba(220,255,235,0.85); margin-top:6px }

  /* ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  .table-footer {
    margin-top:10px;
    padding:10px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006));
    border:1px solid rgba(255,255,255,0.03);
    color:rgba(235,255,245,0.9);
    font-size:14px;
  }

  /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ â€” Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
  .side {
    width:360px;
    min-width:280px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006));
    border-radius:12px;
    padding:12px;
    border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 8px 24px rgba(0,0,0,0.45);
  }

  /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  input[type="text"], input[type="number"], select, textarea {
    padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06);
    background: rgba(0,0,0,0.12); color:var(--text); font-size:14px; min-width:0;
  }
  textarea{ min-height:64px; resize:vertical }

  label { font-size:13px; color:rgba(255,255,255,0.9); margin-bottom:6px; display:block }

  /* Ø£Ø²Ø±Ø§Ø± */
  .btn {
    background: linear-gradient(180deg,var(--accent), color-mix(in srgb,var(--accent) 60%, black 16%));
    border: none; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; color:#012;
    box-shadow:0 8px 24px rgba(0,0,0,0.35)
  }
  .btn.ghost { background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.06) }
  .small { padding:8px 10px; font-size:13px }

  /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ */
  .list-rows { max-height:280px; overflow:auto; display:flex; flex-direction:column; gap:8px; margin-top:6px }
  .row-item { display:flex; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; background:rgba(0,0,0,0.12); border:1px solid rgba(255,255,255,0.02) }
  .row-item .meta { text-align:left; font-size:13px }
  .row-item .actions { display:flex; gap:6px }

  /* Ø®ÙŠØ§Ø±Ø§Øª ØªØµØ¯ÙŠØ± */
  .exports { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }

  /* Ø³ÙˆÙŠØ´Ø± Ø§Ù„ÙˆØ¶Ø¹ */
  .toggle { display:inline-flex; align-items:center; gap:6px; cursor:pointer }

  /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
  @media (max-width:1100px){
    .app{ flex-direction:column; padding:12px }
    .side { width:100% }
    .preview { width:100% }
  }

  /* tooltip ØµØºÙŠØ± */
  .muted { color: rgba(255,255,255,0.6); font-size:13px }

  /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
  .pulse { animation: pulseGlow 2s infinite; }
  @keyframes pulseGlow { 0%{ box-shadow:0 6px 24px color-mix(in srgb,var(--accent) 18%, transparent) } 50%{ box-shadow:0 10px 40px color-mix(in srgb,var(--accent) 30%, transparent) } 100%{ box-shadow:0 6px 24px color-mix(in srgb,var(--accent) 18%, transparent) } }
</style>
</head>
<body>

<!-- Ø®Ù„ÙÙŠØ© Ù…Ø§Ø¦ÙŠØ© Ùˆ ÙÙ‚Ø§Ø¹Ø§Øª -->
<div class="liquid-bg" aria-hidden="true">
  <div class="wave"></div>
  <div class="bubbles" id="bubblesHolder"></div>
</div>

<div class="app" role="application" aria-label="Liquid Glass Table Builder">

  <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
  <div class="preview panel">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div>
        <div style="font-weight:800;color: color-mix(in srgb,var(--accent) 78%, white 22%);">Liquid Glass Table Builder v2</div>
        <div class="muted" style="font-size:13px">ØªØµÙ…ÙŠÙ… Ù…Ø§Ø¦ÙŠ ÙÙŠØ±ÙˆØ²ÙŠ-Ø²ÙŠØªÙˆÙ†ÙŠ â€” Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØªØµØ¯ÙŠØ±</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="saveLocalBtn" class="btn small">Ø­ÙØ¸ Ø§Ù„Ø¢Ù†</button>
        <button id="clearLocalBtn" class="btn ghost small">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
      </div>
    </div>

    <div class="table-wrap" id="exportArea"> <!-- this area will be exported -->
      <div class="panel" style="margin-top:12px; padding:14px;">
        <div class="title" id="previewTitle">Ø¹Ø±ÙˆØ¶ Ø´Ø§Ø´Ø§Øª Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬</div>

        <div id="tableContainer">
          <!-- Ø¬Ø¯ÙˆÙ„ ÙŠÙÙˆÙ„Ø¯ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>

        <div class="table-footer" id="tableFooter">
          <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        </div>
      </div>
    </div>

  </div>

  <!-- Ø§Ù„Ø£Ø¯ÙˆØ§Øª -->
  <div class="side">

    <!-- Ø¥Ø¶Ø§ÙØ© ØµÙ -->
    <div class="card">
      <label>Ø£Ø¶Ù ØµÙ Ø¬Ø¯ÙŠØ¯</label>
      <div class="row" style="gap:10px">
        <input id="inpBrand" type="text" placeholder="Ø§Ù„Ù†ÙˆØ¹ (Ù…Ø«Ø§Ù„: Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬)" />
        <input id="inpSize" type="text" placeholder="Ø§Ù„Ø­Ø¬Ù… (Ù…Ø«Ø§Ù„: 43 Ø¨ÙˆØµØ©)" style="width:120px" />
      </div>
      <div class="row" style="margin-top:10px;gap:10px">
        <input id="inpDims" type="text" placeholder="Ø§Ù„Ù…Ù‚Ø§Ø³ (Ù…Ø«Ø§Ù„: 95Ã—55 Ø³Ù…)" style="flex:1" />
        <input id="inpPrice" type="text" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: 150000)" style="width:140px" />
      </div>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div style="display:flex;gap:8px">
          <button id="addRow" class="btn">Ø£Ø¶Ù</button>
          <button id="addSample" class="btn ghost">Ø£Ø¶Ù Ø¹ÙŠÙ†Ø§Øª</button>
        </div>
        <div style="display:flex;gap:6px">
          <input id="search" placeholder="Ø¨Ø­Ø«..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)" />
        </div>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
    <div class="card">
      <label>ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø©)</label>
      <textarea id="footerInput" placeholder="Ù…Ø«Ø§Ù„: Ù„Ù„Ø­Ø¬Ø² Ø§ØªØµÙ„ Ø¹Ù„Ù‰ 077xxxxxxx Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø©"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="applyFooter" class="btn small">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ°ÙŠÙŠÙ„</button>
        <button id="clearFooter" class="btn ghost small">Ù…Ø³Ø­ Ø§Ù„ØªØ°ÙŠÙŠÙ„</button>
      </div>
    </div>

    <!-- Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª Ùˆ Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
    <div class="card">
      <label>Ø§Ù„Ø£Ù„ÙˆØ§Ù† / Ø§Ù„Ø«ÙŠÙ…</label>
      <div class="row" style="align-items:center;gap:8px">
        <input id="colorInput" type="color" value="#39c2a6" title="ØºÙŠØ± Ø§Ù„Ù„ÙˆÙ†" />
        <select id="preset" style="padding:8px;border-radius:8px;">
          <option value="#39c2a6">ÙÙŠØ±ÙˆØ²ÙŠ-Ø²ÙŠØªÙˆÙ†ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
          <option value="#00b3ff">ÙÙŠØ±ÙˆØ²ÙŠ Ø³Ø§Ø·Ø¹</option>
          <option value="#6fcf97">Ø£Ø®Ø¶Ø± ÙØ§ØªØ­</option>
          <option value="#8a6b9b">Ø¨Ù†ÙØ³Ø¬ÙŠ Ù‡Ø§Ø¯Ø¦</option>
          <option value="#ffb86b">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¯Ø§ÙØ¦</option>
        </select>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <label class="muted">Ø§Ù„ÙˆØ¶Ø¹</label>
          <button id="toggleMode" class="btn ghost small">ØªØ¨Ø¯ÙŠÙ„ Ù„Ù€Ù€ Dark/Light</button>
        </div>
      </div>

      <div style="margin-top:10px" class="muted">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ø¶Ø§ÙÙŠØ©</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="autoSaveToggle" class="btn ghost small">ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
        <button id="clearAll" class="btn ghost small">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ</button>
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ -->
    <div class="card">
      <label>Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
      <div class="list-rows" id="rowsList"></div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="muted">Ø­ÙØ¸ / Ø§Ø³ØªÙŠØ±Ø§Ø¯</div>
        <div style="display:flex;gap:8px">
          <button id="saveJSON" class="btn ghost small">ØªÙ†Ø²ÙŠÙ„ JSON</button>
          <input id="uploadJSON" type="file" accept=".json" style="display:none">
          <button id="btnUpload" class="btn ghost small">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
        </div>
      </div>

      <div class="exports">
        <button id="downloadXLS" class="btn small">ØªØ­Ù…ÙŠÙ„ Excel</button>
        <button id="downloadPDF" class="btn small">ØªØ­Ù…ÙŠÙ„ PDF</button>
        <button id="downloadPNG" class="btn small">ØªØ­Ù…ÙŠÙ„ PNG</button>
        <button id="downloadIMG" class="btn ghost small">Ø­ÙØ¸ ØµÙˆØ±Ø© (PNG)</button>
      </div>
    </div>

    <!-- Ù†Ø³Ø® Ùˆ Ø®ÙŠØ§Ø±Ø§Øª -->
    <div class="card">
      <label>Ù†Ø³Ø® / Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØµØ¯ÙŠØ±</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="copyHTML" class="btn ghost small">Ù†Ø³Ø® HTML</button>
        <button id="copyText" class="btn ghost small">Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        <button id="exportPricesOnly" class="btn ghost small">ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙ‚Ø· (PDF)</button>
      </div>
    </div>

  </div>

</div>

<script>
/* ------------------------------
   Model / Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
   ------------------------------ */
let rows = [
  { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"43 Ø¨ÙˆØµØ©", dims:"95Ã—55 Ø³Ù…", price:150000 },
  { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"50 Ø¨ÙˆØµØ©", dims:"109Ã—66 Ø³Ù…", price:235000 },
  { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"55 Ø¨ÙˆØµØ©", dims:"112Ã—68 Ø³Ù…", price:245000 },
  { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"60 Ø¨ÙˆØµØ©", dims:"122Ã—74 Ø³Ù…", price:299000 },
  { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"70 Ø¨ÙˆØµØ©", dims:"â€”", price:429000 },
  { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"75 Ø¨ÙˆØµØ©", dims:"â€”", price:550000 }
];

let footerText = "Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªØ´Ù…Ù„ Ø¶Ù…Ø§Ù† Ø³Ù†Ø© ÙˆØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ ğŸšš";
let autoSave = true;

/* Ø¹Ù†Ø§ØµØ± DOM */
const tableContainer = document.getElementById('tableContainer');
const rowsList = document.getElementById('rowsList');
const previewTitle = document.getElementById('previewTitle');
const tableFooter = document.getElementById('tableFooter');
const inpBrand = document.getElementById('inpBrand');
const inpSize = document.getElementById('inpSize');
const inpDims = document.getElementById('inpDims');
const inpPrice = document.getElementById('inpPrice');
const addRowBtn = document.getElementById('addRow');
const addSampleBtn = document.getElementById('addSample');
const searchInput = document.getElementById('search');
const colorInput = document.getElementById('colorInput');
const preset = document.getElementById('preset');
const footerInput = document.getElementById('footerInput');
const applyFooterBtn = document.getElementById('applyFooter');
const clearFooterBtn = document.getElementById('clearFooter');

const downloadXLS = document.getElementById('downloadXLS');
const downloadPDF = document.getElementById('downloadPDF');
const downloadPNG = document.getElementById('downloadPNG');
const downloadIMG = document.getElementById('downloadIMG');

const saveJSONbtn = document.getElementById('saveJSON');
const uploadJSON = document.getElementById('uploadJSON');
const btnUpload = document.getElementById('btnUpload');
const copyHTML = document.getElementById('copyHTML');
const copyTextBtn = document.getElementById('copyText');
const exportPricesOnly = document.getElementById('exportPricesOnly');
const saveLocalBtn = document.getElementById('saveLocalBtn');
const clearLocalBtn = document.getElementById('clearLocalBtn');
const clearAllBtn = document.getElementById('clearAll');
const autoSaveToggle = document.getElementById('autoSaveToggle');
const toggleMode = document.getElementById('toggleMode');

/* init */
function numberWithCommas(x){ return String(x).replace(/\B(?=(\d{3})+(?!\d))/g,","); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
function hexToRgba(hex,alpha=1){ hex = hex.replace('#',''); if(hex.length===3) hex=hex.split('').map(c=>c+c).join(''); const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16); return `rgba(${r},${g},${b},${alpha})` }

/* Auto-save to localStorage */
function saveToLocal(){
  const data = { rows, footerText, accent:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#39c2a6' };
  localStorage.setItem('lg_builder_v2', JSON.stringify(data));
  showTempToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹');
}
function loadFromLocal(){
  const raw = localStorage.getItem('lg_builder_v2');
  if(!raw) return false;
  try{
    const data = JSON.parse(raw);
    if(Array.isArray(data.rows)) rows = data.rows;
    footerText = data.footerText || footerText;
    if(data.accent) setAccent(data.accent);
    renderAll();
    return true;
  }catch(e){ console.error(e); return false }
}

/* apply accent */
function setAccent(hex){
  document.documentElement.style.setProperty('--accent', hex);
  document.documentElement.style.setProperty('--accent-weak', hexToRgba(hex,0.16));
  document.documentElement.style.setProperty('--glass-border', hexToRgba(hex,0.28));
}
colorInput.addEventListener('input', ()=> { setAccent(colorInput.value); if(autoSave) saveToLocal(); });
preset.addEventListener('change', ()=> { colorInput.value = preset.value; setAccent(preset.value); if(autoSave) saveToLocal(); });

/* bubbles generator */
function createBubbles(){
  const holder = document.getElementById('bubblesHolder');
  holder.innerHTML = '';
  for(let i=0;i<12;i++){
    const b = document.createElement('div');
    b.className='bubble';
    const size = Math.floor(Math.random()*120)+40;
    b.style.width = size+'px';
    b.style.height = size+'px';
    b.style.left = Math.floor(Math.random()*100)+'%';
    b.style.animationDuration = (8+Math.random()*8)+'s';
    b.style.opacity = (0.08+Math.random()*0.25).toFixed(2);
    b.style.bottom = (Math.random()*10-30)+'%';
    b.style.transform = `translateY(0) scale(${0.9+Math.random()*0.4})`;
    holder.appendChild(b);
  }
}
createBubbles();

/* Render Table + Footer + List */
function renderTable(filter=""){
  const q = String(filter||"").trim().toLowerCase();
  const filtered = rows.filter(r => (r.brand + ' ' + r.size + ' ' + r.dims + ' ' + r.price).toLowerCase().includes(q));
  const table = document.createElement('table');
  table.className = 'stylish';
  table.innerHTML = `
    <thead>
      <tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø­Ø¬Ù…</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr>
    </thead>
    <tbody>
      ${filtered.map((r, idx) => `
        <tr data-idx="${idx}">
          <td>${escapeHTML(r.brand)}</td>
          <td>${escapeHTML(r.size)}<span class="size-small">${escapeHTML(r.dims)}</span></td>
          <td>${numberWithCommas(r.price)}</td>
        </tr>
      `).join('')}
    </tbody>
  `;
  tableContainer.innerHTML = '';
  tableContainer.appendChild(table);

  // footer
  tableFooter.innerHTML = escapeHTML(footerText || '');
}

/* Render side list */
function renderList(){
  rowsList.innerHTML = '';
  rows.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className = 'row-item';
    div.innerHTML = `
      <div class="meta">
        <div style="font-weight:700">${escapeHTML(r.brand)} â€” ${escapeHTML(r.size)}</div>
        <div class="muted">${escapeHTML(r.dims)} â€¢ ${numberWithCommas(r.price)}</div>
      </div>
      <div class="actions">
        <button data-i="${i}" class="btn ghost small editBtn">ØªØ¹Ø¯ÙŠÙ„</button>
        <button data-i="${i}" class="btn ghost small delBtn">Ø­Ø°Ù</button>
      </div>
    `;
    rowsList.appendChild(div);
  });
}

/* initial render */
function renderAll(){
  renderTable(searchInput.value);
  renderList();
  document.getElementById('previewTitle').textContent = 'Ø¹Ø±ÙˆØ¶ Ø´Ø§Ø´Ø§Øª Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬';
  footerInput.value = footerText;
}

/* events: add row */
addRowBtn.addEventListener('click', ()=>{
  const brand = inpBrand.value.trim() || 'â€”';
  const size = inpSize.value.trim() || 'â€”';
  const dims = inpDims.value.trim() || 'â€”';
  const price = parseInt(String(inpPrice.value).replace(/[^0-9]/g,'')) || 0;
  rows.push({ brand, size, dims, price });
  inpBrand.value=''; inpSize.value=''; inpDims.value=''; inpPrice.value='';
  renderAll(); if(autoSave) saveToLocal();
});

/* add sample */
addSampleBtn.addEventListener('click', ()=>{
  rows = rows.concat([
    { brand:"Ù†Ø§Ø´ÙˆÙ†Ø§Ù„", size:"32 Ø¨ÙˆØµØ©", dims:"73Ã—43 Ø³Ù…", price:99000 },
    { brand:"Ù†Ø§Ø´ÙˆÙ†Ø§Ù„", size:"43 Ø¨ÙˆØµØ©", dims:"95Ã—55 Ø³Ù…", price:169000 }
  ]);
  renderAll(); if(autoSave) saveToLocal();
});

/* edit & delete from list (event delegation) */
rowsList.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const i = Number(btn.dataset.i);
  if(btn.classList.contains('delBtn')){
    if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙØŸ')){
      rows.splice(i,1); renderAll(); if(autoSave) saveToLocal();
    }
  } else if(btn.classList.contains('editBtn')){
    const r = rows[i];
    const brand = prompt('Ø§Ù„Ù†ÙˆØ¹:', r.brand); if(brand===null) return;
    const size = prompt('Ø§Ù„Ø­Ø¬Ù…:', r.size); if(size===null) return;
    const dims = prompt('Ø§Ù„Ù…Ù‚Ø§Ø³:', r.dims); if(dims===null) return;
    const price = prompt('Ø§Ù„Ø³Ø¹Ø±:', r.price); if(price===null) return;
    rows[i] = { brand:brand||'â€”', size:size||'â€”', dims:dims||'â€”', price: parseInt(String(price).replace(/[^0-9]/g,''))||0 };
    renderAll(); if(autoSave) saveToLocal();
  }
});

/* search */
searchInput.addEventListener('input', ()=> renderTable(searchInput.value));

/* footer handlers */
applyFooterBtn.addEventListener('click', ()=>{
  footerText = footerInput.value.trim();
  renderAll(); if(autoSave) saveToLocal();
});
clearFooterBtn.addEventListener('click', ()=>{ footerText=''; footerInput.value=''; renderAll(); if(autoSave) saveToLocal(); });

/* save json */
saveJSONbtn.addEventListener('click', ()=>{
  const data = { rows, footerText, accent:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  downloadURL(url, 'offers.json');
  setTimeout(()=> URL.revokeObjectURL(url),1200);
});

/* upload json */
btnUpload.addEventListener('click', ()=> uploadJSON.click());
uploadJSON.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    try{
      const d = JSON.parse(reader.result);
      if(Array.isArray(d.rows)){ rows = d.rows; footerText = d.footerText || footerText; if(d.accent) setAccent(d.accent); renderAll(); if(autoSave) saveToLocal(); }
      else alert('Ù…Ù„Ù JSON ØºÙŠØ± ØµØ­ÙŠØ­');
    }catch(err){ alert('Ø®Ø·Ø£ Ø¨Ù‚Ø±Ø§Ø¡Ø© JSON'); }
  };
  reader.readAsText(f);
});

/* copy HTML & text */
copyHTML.addEventListener('click', async ()=>{
  const html = document.querySelector('.table-wrap').outerHTML;
  await navigator.clipboard.writeText(html);
  showTempToast('ØªÙ… Ù†Ø³Ø® HTML');
});
copyTextBtn.addEventListener('click', async ()=>{
  let txt = '';
  rows.forEach(r=> txt += `${r.brand}\t${r.size}\t${r.dims}\t${r.price}\n`);
  await navigator.clipboard.writeText(txt);
  showTempToast('ØªÙ… Ù†Ø³Ø® Ù†Øµ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
});

/* export Excel */
downloadXLS.addEventListener('click', ()=>{
  const aoa = [['Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ø­Ø¬Ù…','Ø§Ù„Ù…Ù‚Ø§Ø³','Ø§Ù„Ø³Ø¹Ø±']];
  rows.forEach(r=> aoa.push([r.brand, r.size, r.dims, r.price]));
  if(footerText) aoa.push(['','', 'Ù…Ù„Ø§Ø­Ø¸Ø©', footerText]);
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Offers');
  const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  downloadURL(url, 'offers.xlsx');
  setTimeout(()=> URL.revokeObjectURL(url),1200);
});

/* export PDF (full preview) */
downloadPDF.addEventListener('click', ()=> {
  const element = document.querySelector('.table-wrap');
  const opt = {
    margin:0.4,
    filename: 'offers.pdf',
    image:{type:'jpeg', quality:0.98},
    html2canvas:{scale:2, useCORS:true, logging:false},
    jsPDF:{unit:'in', format:'a4', orientation:'portrait'}
  };
  html2pdf().set(opt).from(element).save();
});

/* export PNG (via html2canvas) */
downloadPNG.addEventListener('click', async ()=>{
  const element = document.querySelector('.table-wrap');
  html2canvas(element, { scale:2, useCORS:true, backgroundColor: null }).then(canvas=>{
    canvas.toBlob(blob=>{
      const url = URL.createObjectURL(blob);
      downloadURL(url, 'offers.png');
      setTimeout(()=> URL.revokeObjectURL(url),1200);
    }, 'image/png', 0.95);
  });
});

/* save image direct */
downloadIMG.addEventListener('click', async ()=>{
  const el = document.querySelector('.table-wrap');
  html2canvas(el, {scale:3, useCORS:true, backgroundColor:null}).then(canvas=>{
    canvas.toBlob(blob=>{
      const url = URL.createObjectURL(blob);
      downloadURL(url, 'offers_image.png');
      setTimeout(()=> URL.revokeObjectURL(url),1200);
    }, 'image/png', 0.98)
  });
});

/* export prices only (PDF) */
exportPricesOnly.addEventListener('click', ()=>{
  // Ù†ÙˆÙ„Ø¯ Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª Ù„Ù„Ù€ prices only
  const container = document.createElement('div');
  container.style.padding='18px';
  container.style.background='#fff';
  container.innerHTML = `<h3 style="text-align:center">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3><table style="width:100%;border-collapse:collapse">${rows.map(r=>`<tr><td style="padding:8px;border-bottom:1px solid #ddd">${escapeHTML(r.size)}</td><td style="padding:8px;border-bottom:1px solid #ddd">${numberWithCommas(r.price)}</td></tr>`).join('')}</table>`;
  document.body.appendChild(container);
  html2pdf().from(container).save().finally(()=> container.remove());
});

/* download util */
function downloadURL(url, filename){
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
}

/* save / clear local */
saveLocalBtn.addEventListener('click', ()=> saveToLocal());
clearLocalBtn.addEventListener('click', ()=>{
  if(confirm('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ØŸ')) {
    localStorage.removeItem('lg_builder_v2');
    rows = [
      { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"43 Ø¨ÙˆØµØ©", dims:"95Ã—55 Ø³Ù…", price:150000 },
      { brand:"Ø³Ø§Ù…Ø³ÙˆÙ†Ùƒ", size:"50 Ø¨ÙˆØµØ©", dims:"109Ã—66 Ø³Ù…", price:235000 }
    ];
    footerText = "Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªØ´Ù…Ù„ Ø¶Ù…Ø§Ù† Ø³Ù†Ø© ÙˆØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ ğŸšš";
    setAccent('#39c2a6');
    renderAll();
  }
});

/* clear all */
clearAllBtn.addEventListener('click', ()=>{
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙˆÙØŸ')) return;
  rows=[];
  renderAll(); if(autoSave) saveToLocal();
});

/* autosave toggle */
autoSaveToggle.addEventListener('click', ()=>{
  autoSave = !autoSave;
  autoSaveToggle.textContent = autoSave ? 'ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ';
  if(autoSave) saveToLocal();
});

/* mode toggle (light/dark simple) */
let lightMode=false;
toggleMode.addEventListener('click', ()=>{
  lightMode = !lightMode;
  if(lightMode){
    document.documentElement.style.setProperty('--glass-bg','rgba(255,255,255,0.06)');
    document.documentElement.style.setProperty('--text','#062420');
    document.body.style.background = 'linear-gradient(135deg,#eaf8f5 0%, #dff6f0 60%)';
    toggleMode.textContent = 'ØªØ¨Ø¯ÙŠÙ„ Ù„Ù€Ù€ Dark/Light';
  } else {
    document.documentElement.style.setProperty('--glass-bg','rgba(140,200,180,0.10)');
    document.documentElement.style.setProperty('--text','#e9fffb');
    document.body.style.background = 'linear-gradient(135deg,#0b1f1a 0%, #092b27 40%, #071615 100%)';
    toggleMode.textContent = 'ØªØ¨Ø¯ÙŠÙ„ Ù„Ù€Ù€ Dark/Light';
  }
});

/* export CSV helper (optional) */
function rowsToCSV(){
  let txt = 'Ø§Ù„Ù†ÙˆØ¹,Ø§Ù„Ø­Ø¬Ù…,Ø§Ù„Ù…Ù‚Ø§Ø³,Ø§Ù„Ø³Ø¹Ø±\n';
  rows.forEach(r=> txt += `${r.brand},${r.size},${r.dims},${r.price}\n`);
  return txt;
}

/* export HTML copy - handled above */

/* small toast */
function showTempToast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position='fixed';
  t.style.left='50%';
  t.style.transform='translateX(-50%)';
  t.style.bottom='28px';
  t.style.padding='10px 14px';
  t.style.borderRadius='12px';
  t.style.background='rgba(0,0,0,0.7)';
  t.style.color='#fff';
  t.style.zIndex=9999;
  document.body.appendChild(t);
  setTimeout(()=> t.style.opacity='0.01',1400);
  setTimeout(()=> t.remove(),2000);
}

/* intelligent accent suggestion (based on avg price) */
function suggestAccentByData(){
  if(rows.length===0) return;
  const avg = rows.reduce((s,r)=>s+(r.price||0),0)/rows.length;
  if(avg > 300000) { setAccent('#8a6b9b'); colorInput.value='#8a6b9b'; } // purple for high
  else if(avg > 200000) { setAccent('#39c2a6'); colorInput.value='#39c2a6'; } // default
  else { setAccent('#00b3ff'); colorInput.value='#00b3ff'; } // bright cyan for low-medium
}

/* small UI improvements: click on preview row => edit */
tableContainer.addEventListener('click', (e)=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  const idx = Number(tr.dataset.idx);
  if(Number.isNaN(idx)) return;
  if(!confirm('ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ØµÙØŸ')) return;
  const r = rows[idx];
  const brand = prompt('Ø§Ù„Ù†ÙˆØ¹:', r.brand); if(brand===null) return;
  const size = prompt('Ø§Ù„Ø­Ø¬Ù…:', r.size); if(size===null) return;
  const dims = prompt('Ø§Ù„Ù…Ù‚Ø§Ø³:', r.dims); if(dims===null) return;
  const price = prompt('Ø§Ù„Ø³Ø¹Ø±:', r.price); if(price===null) return;
  rows[idx] = { brand:brand||'â€”', size:size||'â€”', dims:dims||'â€”', price: parseInt(String(price).replace(/[^0-9]/g,''))||0 };
  renderAll(); if(autoSave) saveToLocal();
});

/* initial load from local or default */
if(!loadFromLocal()) { renderAll(); setAccent('#39c2a6'); colorInput.value='#39c2a6'; }

/* autosave periodically */
setInterval(()=>{ if(autoSave) saveToLocal(); }, 12000);

/* small improvement: show small pulsating on add sample */
addSampleBtn.addEventListener('click', ()=> addSampleBtn.classList.add('pulse'), setTimeout(()=> addSampleBtn.classList.remove('pulse'),800));

/* helper: temporary animation on many actions */
function briefPulse(el){ el.classList.add('pulse'); setTimeout(()=> el.classList.remove('pulse'),900) }

/* small UX: show list after each render */
function refreshAllViews(){ renderAll(); briefPulse(document.querySelector('.panel')); suggestAccentByData(); }

/* call render after changing rows */
const originalRenderAll = renderAll;
function renderAndSave(){ renderAll(); if(autoSave) saveToLocal(); }

/* overwrite render functions to keep consistent usage */
function renderAll(){ renderTable(searchInput.value); renderList(); document.getElementById('previewTitle').textContent='Ø¹Ø±ÙˆØ¶ Ø´Ø§Ø´Ø§Øª Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬'; tableFooter.innerHTML = escapeHTML(footerText || ''); }

/* wire up small controls still referencing functions */
document.querySelectorAll('#addRow').forEach(btn => btn.addEventListener('click', ()=> { renderAndSave(); }));
document.getElementById('addRow').addEventListener('click', ()=> { /* already handled earlier */ });

/* key UX: when input price change, format? we'll keep raw numeric on save */

/* finally ensure UI reflects initial state */
renderAll();

/* small accessibility: ENTER on price adds row */
inpPrice.addEventListener('keydown', (e)=> { if(e.key==='Enter') addRowBtn.click(); });

</script>
</body>
</html>
