<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ø§Ù…</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
  :root{
    --bg:#0f1420;--panel:#121a2a;--glass:rgba(255,255,255,.06);
    --text:#e8eefb;--muted:#a9b4c7;--brand:#55c2ff;--brand-2:#6affc2;
    --ok:#33d17a;--warn:#ffb545;--danger:#ff6b6b;--line:rgba(255,255,255,.12);
    --radius:14px;--shadow:0 12px 40px rgba(0,0,0,.35)
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:linear-gradient(160deg,#0b1220,#0a1730 60%,#09192f);
    color:var(--text);font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  }

  /* Header */
  header{
    position:fixed;inset:0 0 auto 0;height:64px;display:flex;align-items:center;gap:12px;
    padding:0 16px;background:rgba(8,14,26,.6);backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line);z-index:1001
  }
  .menu-btn{font-size:22px;line-height:1;padding:10px 12px;border:none;cursor:pointer;border-radius:10px;
    color:#081019;background:linear-gradient(135deg,var(--brand),var(--brand-2));font-weight:700}
  .title{font-weight:800;letter-spacing:.2px}

  /* Sidebar (hidden by default; slide-in) */
  .sidebar{
    position:fixed;top:0;right:-280px;height:100%;width:260px;padding:18px;
    background:rgba(18,26,42,.9);backdrop-filter:blur(12px);border-left:1px solid var(--line);
    transition:right .28s ease;z-index:1002
  }
  .sidebar.active{right:0}
  .side-h{margin:70px 0 10px;color:var(--muted);font-weight:700}
  .nav-btn{
    width:100%;text-align:right;padding:12px;border:none;border-radius:10px;margin:6px 0;cursor:pointer;
    color:var(--text);background:transparent;border:1px solid var(--line);transition:.2s
  }
  .nav-btn:hover{background:var(--glass)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:1000}
  .overlay.active{display:block}

  /* Content */
  .container{max-width:1200px;margin:96px auto 60px;padding:0 16px}
  .section{display:none}
  .section.active{display:block}

  /* Cards / stats */
  .grid{display:grid;gap:16px}
  .grid.cols-3{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  .card{
    background:var(--glass);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
    padding:18px
  }
  .clickable{cursor:pointer;transition:.2s}
  .clickable:hover{transform:translateY(-2px)}
  .stat-val{font-size:32px;font-weight:900;margin:6px 0;color:#fff}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}

  /* Forms + Table */
  .row{display:flex;flex-wrap:wrap;gap:10px}
  input,select,button,textarea{
    background:#0e1524;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:none
  }
  input::placeholder{color:#7f8aa1}
  button.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#081019;border:none;font-weight:800}
  button.ghost{background:transparent}
  button.warn{background:var(--warn);border:none;color:#141b2b;font-weight:800}
  button.danger{background:var(--danger);border:none;color:#fff;font-weight:800}

  table{width:100%;border-collapse:collapse;margin-top:12px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:11px;border-bottom:1px solid var(--line);text-align:center}
  th{background:rgba(255,255,255,.06);color:#bfe6ff}
  tr:hover{background:rgba(255,255,255,.04)}
  .actions button{margin:0 4px}

  /* Pills */
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);display:inline-flex;gap:6px;align-items:center}

  /* Toast */
  .toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);
         background:#101a2d;border:1px solid var(--line);padding:10px 14px;border-radius:10px;display:none;z-index:2000}
  .toast.show{display:block;animation:fade .2s}
  @keyframes fade{from{opacity:.6;transform:translate(-50%,-6px)}to{opacity:1;transform:translate(-50%,0)}}

  /* Section headers */
  h2{margin:6px 0 12px}
</style>
</head>
<body>

<header>
  <button class="menu-btn" id="menuBtn">â˜°</button>
  <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</div>
</header>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="side-h">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
  <button class="nav-btn" onclick="showSection('employees')">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
  <button class="nav-btn" onclick="showSection('tasks')">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</button>
  <button class="nav-btn" onclick="showSection('delayed')">â³ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©</button>
  <button class="nav-btn" onclick="showSection('stats')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</button>

  <div class="side-h">Ø£Ø¯ÙˆØ§Øª</div>
  <button class="nav-btn" onclick="exportEmployees()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (CSV)</button>
  <button class="nav-btn" onclick="exportTasks()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù‡Ø§Ù… (CSV)</button>
</aside>
<div class="overlay" id="overlay"></div>

<div class="container">

  <!-- ğŸ“Œ Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª (ØªÙØ§Ø¹Ù„ÙŠØ©) -->
  <section id="stats" class="section active">
    <div class="grid cols-3">
      <div class="card clickable" onclick="showSection('employees')">
        <div class="badge">Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</div>
        <div class="stat-val" id="statEmployees">0</div>
        <div class="muted">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
      </div>
      <div class="card clickable" onclick="showSection('tasks')">
        <div class="badge">Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</div>
        <div class="stat-val" id="statTasksToday">0</div>
        <div class="muted">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…</div>
      </div>
      <div class="card clickable" onclick="showSection('delayed')">
        <div class="badge">Ù…Ø¤Ø¬Ù‘Ù„Ø©</div>
        <div class="stat-val" id="statDelayed">0</div>
        <div class="muted">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ø¬Ù‘Ù„Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙˆÙ„ØªÙ‡Ø§</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="row">
          <div class="pill">ğŸ—“ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…: <b id="todayTxt" style="margin-inline-start:6px"></b></div>
          <div class="pill">ğŸ† Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø· Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: <b id="statPointsWeek" style="margin-inline-start:6px">0</b></div>
          <div class="pill">â±ï¸ Ø¢Ø®Ø± ØªØµÙÙŠØ±: <b id="lastReset" style="margin-inline-start:6px">â€”</b></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
  <section id="employees" class="section">
    <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
    <div class="card">
      <div class="row">
        <input id="empName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" />
        <button class="primary" onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
        <input id="empSearch" placeholder="Ø¨Ø­Ø«..." oninput="filterEmployees()"/>
      </div>
      <table>
        <thead>
          <tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th><th>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
        </thead>
        <tbody id="empTable"></tbody>
      </table>
    </div>
  </section>

  <!-- ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… (Ø¥Ù†Ø´Ø§Ø¡ + Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®) -->
  <section id="tasks" class="section">
    <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h2>
    <div class="card">
      <div class="row">
        <select id="empSelect"></select>
        <input type="date" id="taskDate"/>
      </div>
      <div id="taskFields" class="row" style="margin-top:6px">
        <input class="taskInput" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø©"/>
      </div>
      <div class="row">
        <button class="ghost" onclick="addTaskField()">â• Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„</button>
        <button class="primary" onclick="saveTasks()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <select id="viewEmpFilter"></select>
        <input type="date" id="viewDate" />
        <button onclick="loadTasksTable()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <table>
        <thead>
          <tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th></tr>
        </thead>
        <tbody id="tasksTable"></tbody>
      </table>
    </div>
  </section>

  <!-- â³ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¤Ø¬Ù„Ø© -->
  <section id="delayed" class="section">
    <h2>â³ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©</h2>
    <div class="card">
      <div class="row">
        <select id="delayedEmpFilter"></select>
        <button onclick="loadDelayed()">ØªØ­Ø¯ÙŠØ«</button>
      </div>
      <table>
        <thead>
          <tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ù…Ø±Ø§Øª Ø§Ù„ØªØ£Ø¬ÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‚ØªØ±Ø­</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
        </thead>
        <tbody id="delayedTable"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
  /* ================= Firebase ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyA7KirsWgafKXPsQfFl3v6ssMaAb_zjTps",
    authDomain: "tasks-bce7f.firebaseapp.com",
    databaseURL: "https://tasks-bce7f-default-rtdb.firebaseio.com",
    projectId: "tasks-bce7f",
    storageBucket: "tasks-bce7f.firebasestorage.app",
    messagingSenderId: "493499367071",
    appId: "1:493499367071:web:c667a4666f1e84d8b32caa",
    measurementId: "G-HR305C8QHR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /* =============== Helpers =============== */
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const todayStr = () => new Date().toISOString().slice(0,10);
  const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); };
  const EMP_REF = db.ref("employees");
  const DAILY_REF = db.ref("tasksDaily");
  const DELAYED_REF = db.ref("delayedTasks");
  const META_REF = db.ref("meta");

  /* =============== Sidebar Toggle =============== */
  const sidebar = $("#sidebar"), overlay=$("#overlay"), menuBtn=$("#menuBtn");
  menuBtn.onclick = ()=>{ sidebar.classList.add("active"); overlay.classList.add("active"); }
  overlay.onclick = ()=>{ sidebar.classList.remove("active"); overlay.classList.remove("active"); }
  document.addEventListener("click",(e)=>{
    if(!sidebar.contains(e.target) && !menuBtn.contains(e.target)) { sidebar.classList.remove("active"); overlay.classList.remove("active"); }
  });

  /* =============== Sections =============== */
  function showSection(id){
    $$(".section").forEach(s=>s.classList.remove("active"));
    $("#"+id).classList.add("active");
    if(id==="stats") updateStats();
    if(id==="tasks") { fillEmpSelects(); }
    if(id==="delayed") { fillEmpSelects(); loadDelayed(); }
    if(id==="employees") {} // nothing
  }

  /* =============== Employees CRUD =============== */
  $("#todayTxt").textContent = todayStr();

  function addEmployee(){
    const name = $("#empName").value.trim();
    if(!name){ toast("âš ï¸ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"); return; }
    const ref = EMP_REF.push();
    ref.set({ name, points:0 }).then(()=>{
      $("#empName").value="";
      toast("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù");
    });
  }

  function employeeLink(id){
    // ÙŠØ´ØªØºÙ„ Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„ÙÙŠÙ† Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯
    return `${location.origin}/employee.html?emp=${id}`;
  }

  function renderEmployees(data){
    const tbody = $("#empTable"); tbody.innerHTML="";
    const select = $("#empSelect"); const viewEmp = $("#viewEmpFilter"); const delayedEmp = $("#delayedEmpFilter");
    select.innerHTML=""; viewEmp.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>"; delayedEmp.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";

    const query = ($("#empSearch").value||"").toLowerCase();
    let count=0;
    for(const id in data){
      const emp = data[id]; const name = emp.name || "â€”";
      if(query && !name.toLowerCase().includes(query)) continue;
      count++;
      const link = employeeLink(id);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        <td><b>${emp.points||0}</b></td>
        <td style="direction:ltr"><a href="${link}" target="_blank">${link}</a></td>
        <td class="actions">
          <button onclick="copyLink('${link}')">ğŸ“‹ Ù†Ø³Ø®</button>
          <button class="danger" onclick="deleteEmp('${id}')">ğŸ—‘ Ø­Ø°Ù</button>
        </td>`;
      tbody.appendChild(tr);

      select.innerHTML += `<option value="${id}">${name}</option>`;
      viewEmp.innerHTML += `<option value="${id}">${name}</option>`;
      delayedEmp.innerHTML += `<option value="${id}">${name}</option>`;
    }
    $("#statEmployees").textContent = count;
  }

  function copyLink(link){ navigator.clipboard.writeText(link); toast("ğŸ“ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·"); }
  function deleteEmp(id){
    if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙƒØ§ÙØ© Ù…Ù‡Ø§Ù…Ù‡ØŸ")) return;
    EMP_REF.child(id).remove();
    DAILY_REF.child(id).remove();
    DELAYED_REF.child(id).remove();
  }

  EMP_REF.on("value",s=>{ renderEmployees(s.val()||{}); });

  function filterEmployees(){ EMP_REF.once("value").then(s=>renderEmployees(s.val()||{})); }

  /* =============== Create & View Tasks =============== */
  function addTaskField(){
    const inp = document.createElement("input");
    inp.className="taskInput"; inp.placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø©";
    $("#taskFields").appendChild(inp);
  }

  function fillEmpSelects(){
    EMP_REF.once("value").then(s=>{
      const data=s.val()||{};
      const sel=$("#empSelect"); const viewEmp=$("#viewEmpFilter");
      if(sel && sel.options.length<=0){ // already filled by render? skip
        sel.innerHTML="";
        for(const id in data) sel.innerHTML += `<option value="${id}">${data[id].name||"â€”"}</option>`;
      }
      if(viewEmp && viewEmp.options.length<=1){
        viewEmp.innerHTML="<option value=''>Ø§Ù„ÙƒÙ„</option>";
        for(const id in data) viewEmp.innerHTML += `<option value="${id}">${data[id].name||"â€”"}</option>`;
      }
    });
  }

  function saveTasks(){
    const empId = $("#empSelect").value;
    const date = $("#taskDate").value || todayStr();
    const tasks = [...$$(".taskInput")].map(i=>i.value.trim()).filter(Boolean);
    if(!empId){ toast("âš ï¸ Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù"); return; }
    if(!tasks.length){ toast("âš ï¸ Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }
    const ref = DAILY_REF.child(`${empId}/${date}`);
    const updates = {};
    tasks.forEach(t=>{
      const id = db.ref().push().key;
      updates[id] = { text:t, status:"pending", delayCount:0, createdAt:Date.now() };
    });
    ref.update(updates).then(()=>{ toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ø§Ù…"); $("#taskFields").innerHTML=`<input class="taskInput" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù‡Ù…Ø©"/>`; });
  }

  function loadTasksTable(){
    const empFilter = $("#viewEmpFilter").value;
    const date = $("#viewDate").value || todayStr();
    const tbody = $("#tasksTable"); tbody.innerHTML="";
    DAILY_REF.once("value").then(s=>{
      const data=s.val()||{};
      let total=0;
      const rows=[];
      for(const empId in data){
        if(empFilter && empFilter!==empId) continue;
        const byDate = data[empId][date];
        if(!byDate) continue;
        const count = Object.keys(byDate).length;
        total += count;
        rows.push({empId,date,count,details:Object.values(byDate).map(t=>t.text)});
      }
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${r.empId}</td><td>${r.date}</td><td>${r.count}</td><td>${r.details.join(" â€¢ ")}</td>`;
        tbody.appendChild(tr);
      });
      $("#statTasksToday").textContent = total;
    });
  }

  /* =============== Delayed Tasks =============== */
  function loadDelayed(){
    const empFilter = $("#delayedEmpFilter").value;
    const tbody = $("#delayedTable"); tbody.innerHTML="";
    DELAYED_REF.once("value").then(s=>{
      const data=s.val()||{};
      let total=0;
      const promises=[];
      for(const empId in data){
        if(empFilter && empFilter!==empId) continue;
        for(const taskId in data[empId]){
          total++;
          const t = data[empId][taskId];
          const tr=document.createElement("tr");
          tr.innerHTML = `
            <td>${empId}</td>
            <td>${t.text||"â€”"}</td>
            <td>${t.reason||"-"}</td>
            <td>${t.delayCount||0}</td>
            <td>${t.targetDate||"â€”"}</td>
            <td class="actions">
              <input type="date" id="resched-${empId}-${taskId}" value="${(t.targetDate||"").slice(0,10)}"/>
              <button class="primary" onclick="reschedule('${empId}','${taskId}')">ğŸ“… Ø¬Ø¯ÙˆÙ„Ø©</button>
              <button class="danger" onclick="deleteDelayed('${empId}','${taskId}')">ğŸ—‘ Ø­Ø°Ù</button>
            </td>`;
          tbody.appendChild(tr);
        }
      }
      $("#statDelayed").textContent = total;
    });
  }

  function reschedule(empId, taskId){
    const inp = document.getElementById(`resched-${empId}-${taskId}`);
    const date = inp.value || todayStr();
    DELAYED_REF.child(`${empId}/${taskId}`).once("value").then(s=>{
      const t=s.val(); if(!t) return;
      // Ø£Ø¹Ø¯Ù‡Ø§ Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯
      DAILY_REF.child(`${empId}/${date}/${taskId}`).set({
        text:t.text, status:"pending", delayCount:(t.delayCount||0), createdAt:t.createdAt||Date.now()
      });
      // Ø§Ù…Ø³Ø­ Ù…Ù† Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©
      DELAYED_REF.child(`${empId}/${taskId}`).remove().then(()=>{ toast("âœ… ØªÙ…Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©"); loadDelayed(); loadTasksTable(); });
    });
  }

  function deleteDelayed(empId, taskId){
    if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©ØŸ")) return;
    DELAYED_REF.child(`${empId}/${taskId}`).remove().then(()=>{ toast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù"); loadDelayed(); });
  }

  /* =============== Stats (live-ish) =============== */
  function updateStats(){
    $("#todayTxt").textContent = todayStr();

    EMP_REF.once("value").then(s=>{
      const emps = s.val()||{};
      $("#statEmployees").textContent = Object.keys(emps).length;
      // Ø§Ø¬Ù…Ø¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù…Ù† points Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
      let sum=0; for(const id in emps) sum += +((emps[id].points)||0);
      $("#statPointsWeek").textContent = sum;
    });

    // Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…
    DAILY_REF.once("value").then(s=>{
      const data=s.val()||{}; let totalToday=0;
      const today=todayStr();
      for(const emp in data){ if(data[emp][today]) totalToday += Object.keys(data[emp][today]).length; }
      $("#statTasksToday").textContent = totalToday;
    });

    // Ù…Ø¤Ø¬Ù„Ø©
    DELAYED_REF.once("value").then(s=>{
      const data=s.val()||{}; let total=0;
      for(const emp in data) total += Object.keys(data[emp]).length;
      $("#statDelayed").textContent = total;
    });

    // Ø¢Ø®Ø± ØªØµÙÙŠØ±
    META_REF.child("lastReset").once("value").then(s=>{
      $("#lastReset").textContent = s.val() ? new Date(s.val()).toLocaleString() : "â€”";
    });
  }

  /* =============== Weekly Reset (Wednesday 11 PM Asia/Baghdad) =============== */
  // Ù†Ø¹ØªÙ…Ø¯ ÙˆÙ‚Øª Ù…ØªØµÙØ­ Ø§Ù„Ø£Ø¯Ù…Ù†. Ù†Ø¶Ù…Ù† ØªØ´ØºÙŠÙ„Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¹Ø¨Ø± meta/lastReset.
  function maybeWeeklyReset(){
    const now = new Date();
    // Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡=3 Ø­Ø³Ø¨ JS
    const isWed = now.getDay() === 3;
    const is11pm = now.getHours() === 23 && now.getMinutes() === 0;
    if(!(isWed && is11pm)) return;

    META_REF.child("lastReset").once("value").then(s=>{
      const last = s.val() ? new Date(s.val()) : null;
      // Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ù†ÙØ³ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
      if(last && (now - new Date(last)) < 3600*1000) return;

      // ØµÙÙ‘Ø± Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ù…ÙŠØ¹
      EMP_REF.once("value").then(snap=>{
        const updates = {};
        snap.forEach(ch => { updates[`${ch.key}/points`] = 0; });
        if(Object.keys(updates).length){
          EMP_REF.update(updates).then(()=>{
            META_REF.child("lastReset").set(now.toISOString());
            toast("ğŸ”„ ØªÙ… ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹");
            updateStats();
          });
        }
      });
    });
  }
  setInterval(maybeWeeklyReset, 60000); // Ø¯Ù‚ÙŠÙ‚Ø©

  /* =============== Live binds =============== */
  // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  DAILY_REF.on("value", ()=>{ loadTasksTable(); updateStats(); });
  DELAYED_REF.on("value", ()=>{ loadDelayed(); updateStats(); });

  /* =============== Export CSV =============== */
  function downloadCSV(filename, rows){
    const process = r => r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(",");
    const csv = "data:text/csv;charset=utf-8,\uFEFF" + rows.map(process).join("\n");
    const a = document.createElement("a");
    a.href = encodeURI(csv); a.download = filename; a.click();
  }

  function exportEmployees(){
    EMP_REF.once("value").then(s=>{
      const data=s.val()||{}; const rows=[["id","name","points","link"]];
      for(const id in data) rows.push([id, data[id].name||"", data[id].points||0, employeeLink(id)]);
      downloadCSV(`employees_${todayStr()}.csv`, rows);
    });
  }

  function exportTasks(){
    const rows=[["empId","date","taskId","text","status","delayCount"]];
    DAILY_REF.once("value").then(s=>{
      const d=s.val()||{};
      for(const emp in d) for(const date in d[emp]) for(const tid in d[emp][date]){
        const t=d[emp][date][tid];
        rows.push([emp,date,tid,t.text,t.status||"",t.delayCount||0]);
      }
      downloadCSV(`tasksDaily_${todayStr()}.csv`, rows);
    });
  }

  // Ø£ÙˆÙ„ÙŠ
  updateStats();
  // ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ÙŠÙˆÙ…
  $("#viewDate").value = todayStr();
  loadTasksTable();
</script>
</body>
</html>
